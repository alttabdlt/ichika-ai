<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Component Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            font-family: Arial, sans-serif;
            color: white;
        }
        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .video-actor-container {
            position: relative;
            width: 80%;
            max-width: 800px;
            height: 600px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .video-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 200ms ease-in-out;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 800px;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
            color: white;
            font-size: 1.2rem;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video Actor Component Test</h1>
        
        <div class="video-actor-container">
            <video id="videoRef" class="video-layer" muted autoplay loop playsinline></video>
            <video id="nextVideoRef" class="video-layer" style="opacity: 0;" muted autoplay loop playsinline></video>
            <div id="loadingOverlay" class="loading-overlay">
                <div>Loading...</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="setEmotion('neutral')">Neutral</button>
            <button onclick="setEmotion('happy')">Happy</button>
            <button onclick="setEmotion('sad')">Sad</button>
            <button onclick="setEmotion('angry')">Angry</button>
            <button onclick="setEmotion('shy')">Shy</button>
            <button onclick="setEmotion('surprised')">Surprised</button>
        </div>

        <div id="status" class="status">
            Current emotion: <span id="currentEmotion">neutral</span><br>
            Current clip: <span id="currentClip">-</span><br>
            Is transitioning: <span id="isTransitioning">false</span>
        </div>
    </div>

    <script>
        const assetsBase = '/assets/girl/scene01';
        const videoRef = document.getElementById('videoRef');
        const nextVideoRef = document.getElementById('nextVideoRef');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const statusEl = document.getElementById('status');
        
        let currentEmotion = 'neutral';
        let currentClip = '';
        let isTransitioning = false;

        const clipMap = {
            neutral: {
                idle: 'idle/idle_neutral_loop_8s.mp4'
            },
            happy: {
                in: 'emote/happy_in.mp4',
                idle: 'emote/happy_idle.mp4',
                out: 'emote/happy_out.mp4'
            },
            sad: {
                in: 'emote/sad_in.mp4',
                idle: 'emote/sad_idle.mp4',
                out: 'emote/sad_out.mp4'
            },
            angry: {
                in: 'emote/angry_in.mp4',
                idle: 'emote/angry_idle.mp4',
                out: 'emote/angry_out.mp4'
            },
            shy: {
                in: 'emote/shy_in.mp4',
                idle: 'emote/shy_idle.mp4',
                out: 'emote/shy_out.mp4'
            },
            surprised: {
                in: 'emote/surprised_in.mp4',
                idle: 'emote/surprised_idle.mp4',
                out: 'emote/surprised_out.mp4'
            }
        };

        function updateStatus() {
            document.getElementById('currentEmotion').textContent = currentEmotion;
            document.getElementById('currentClip').textContent = currentClip.replace(assetsBase + '/', '');
            document.getElementById('isTransitioning').textContent = isTransitioning;
        }

        async function transitionToClip(clipPath) {
            if (isTransitioning) return;
            
            const fullPath = `${assetsBase}/${clipPath}`;
            
            if (currentClip === fullPath) return;
            
            isTransitioning = true;
            updateStatus();
            
            try {
                // Load the new clip in the next video element
                nextVideoRef.src = fullPath;
                await nextVideoRef.load();
                
                // Start playing with opacity 0
                nextVideoRef.style.opacity = '0';
                await nextVideoRef.play();
                
                // Wait a frame
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Crossfade
                nextVideoRef.style.opacity = '1';
                videoRef.style.opacity = '0';
                
                // Wait for fade to complete
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Swap references
                videoRef.pause();
                const temp = videoRef.src;
                videoRef.src = nextVideoRef.src;
                nextVideoRef.src = temp;
                
                const tempOpacity = videoRef.style.opacity;
                videoRef.style.opacity = nextVideoRef.style.opacity;
                nextVideoRef.style.opacity = tempOpacity;
                
                await videoRef.play();
                
                currentClip = fullPath;
            } catch (error) {
                console.error('Failed to transition to clip:', error);
            } finally {
                isTransitioning = false;
                updateStatus();
            }
        }

        async function setEmotion(emotion) {
            if (currentEmotion === emotion && !isTransitioning) return;
            
            currentEmotion = emotion;
            updateStatus();
            
            if (emotion === 'neutral') {
                await transitionToClip(clipMap.neutral.idle);
            } else {
                const emotionClips = clipMap[emotion];
                if (emotionClips && emotionClips.in) {
                    // Play transition in
                    await transitionToClip(emotionClips.in);
                    
                    // After transition, play idle loop
                    setTimeout(async () => {
                        if (currentEmotion === emotion) {
                            await transitionToClip(emotionClips.idle);
                        }
                    }, 1000);
                } else if (emotionClips) {
                    // No transition, go straight to idle
                    await transitionToClip(emotionClips.idle);
                }
            }
        }

        // Initialize
        async function init() {
            try {
                videoRef.src = `${assetsBase}/${clipMap.neutral.idle}`;
                videoRef.loop = true;
                await videoRef.play();
                currentClip = videoRef.src;
                loadingOverlay.classList.add('hidden');
                updateStatus();
            } catch (error) {
                console.error('Failed to initialize:', error);
                loadingOverlay.innerHTML = '<div>Failed to load video. Check console for errors.</div>';
            }
        }

        // Start when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>